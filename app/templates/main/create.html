{% extends "base.html" %}

{% block title %}å†™æ–‡ç« {% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="juejin-editor">
        <!-- ç¼–è¾‘å™¨å¤´éƒ¨ -->
        <div class="editor-header">
            <!-- å·¥å…·æ  -->
            <div class="juejin-editor-toolbar">
                <!-- å·¦ä¾§ï¼šMarkdownå·¥å…· -->
                <div class="toolbar-left">
                    <button type="button" class="juejin-toolbar-btn" onclick="insertMarkdown('# ', '')" title="æ ‡é¢˜1 (Ctrl+1)">
                        H
                    </button>
                    <button type="button" class="juejin-toolbar-btn" onclick="insertMarkdown('**', '**')" title="åŠ ç²— (Ctrl+B)">
                        <strong>B</strong>
                    </button>
                    <button type="button" class="juejin-toolbar-btn" onclick="insertMarkdown('*', '*')" title="æ–œä½“ (Ctrl+I)">
                        <em>I</em>
                    </button>
                    <button type="button" class="juejin-toolbar-btn" onclick="insertMarkdown('~~', '~~')" title="åˆ é™¤çº¿">
                        <s>S</s>
                    </button>
                    <button type="button" class="juejin-toolbar-btn" onclick="insertMarkdown('`', '`')" title="è¡Œå†…ä»£ç  (Ctrl+Shift+K)">
                        `
                    </button>
                    <div class="juejin-toolbar-separator"></div>
                    <button type="button" class="juejin-toolbar-btn" onclick="insertMarkdown('[', '](url)')" title="é“¾æ¥ (Ctrl+K)">
                        ğŸ”—
                    </button>
                    <button type="button" class="juejin-toolbar-btn" onclick="triggerImageUpload()" title="å›¾ç‰‡ (Ctrl+Shift+I)">
                        ğŸ–¼ï¸
                    </button>
                    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
                    <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
                    <button type="button" class="juejin-toolbar-btn" onclick="insertMarkdown('\n```\n', '\n```\n')" title="ä»£ç å— (Ctrl+Shift+C)">
                        &lt;/&gt;
                    </button>
                    <div class="juejin-toolbar-separator"></div>
                    <button type="button" class="juejin-toolbar-btn" onclick="insertMarkdown('\n- ', '')" title="æ— åºåˆ—è¡¨ (Ctrl+Shift+L)">
                        â€¢
                    </button>
                    <button type="button" class="juejin-toolbar-btn" onclick="insertMarkdown('\n1. ', '')" title="æœ‰åºåˆ—è¡¨">
                        1.
                    </button>
                    <button type="button" class="juejin-toolbar-btn" onclick="insertMarkdown('\n> ', '')" title="å¼•ç”¨">
                        â
                    </button>
                    <div class="juejin-toolbar-separator"></div>
                    <button type="button" class="juejin-toolbar-btn" onclick="insertMarkdown('---\n', '')" title="åˆ†å‰²çº¿">
                        â€•
                    </button>
                    <button type="button" class="juejin-toolbar-btn" onclick="insertTable()" title="è¡¨æ ¼">
                        âŠ
                    </button>
                    <div class="juejin-toolbar-separator"></div>
                    <button type="button" class="juejin-toolbar-btn" onclick="clearEditor()" title="æ¸…ç©º">
                        ğŸ—‘ï¸
                    </button>
                    <button type="button" class="juejin-toolbar-btn" onclick="toggleFullscreen()" title="å…¨å±">
                        â›¶
                    </button>
                    <button type="button" class="juejin-toolbar-btn" onclick="toggleFocusMode()" title="ä¸“æ³¨æ¨¡å¼" id="focusModeBtn">
                        ğŸ¯
                    </button>
                </div>
                
                <!-- å³ä¾§ï¼šæ–‡ç« è®¾ç½® -->
                <div class="toolbar-right">
                    <!-- é¦–å›¾ä¸Šä¼  -->
                    <div class="toolbar-setting-item">
                        <button type="button" class="setting-btn" onclick="triggerCoverImageUpload()" title="è®¾ç½®é¦–å›¾">
                            ğŸ“· é¦–å›¾
                        </button>
                        <input type="file" name="cover_image" id="coverImageInput" accept="image/*" style="display: none;" onchange="handleCoverImageUpload(this)">
                        <div class="cover-preview-mini" id="coverPreviewMini" style="display: none;">
                            <img id="coverImageMini" src="" alt="é¦–å›¾" style="width: 32px; height: 32px; object-fit: cover; border-radius: 4px; border: 1px solid #e4e6ea;">
                            <button type="button" onclick="removeCoverImage()" style="position: absolute; top: -6px; right: -6px; background: #ff4757; color: white; border: none; border-radius: 50%; width: 16px; height: 16px; cursor: pointer; font-size: 10px; line-height: 1;">Ã—</button>
                        </div>
                    </div>
                    
                    <!-- ä¸“æ é€‰æ‹© -->
                    <div class="toolbar-setting-item">
                        <select name="category_id" id="category_id" class="setting-select" title="é€‰æ‹©ä¸“æ ">
                            <option value="">ğŸ“ é€‰æ‹©ä¸“æ </option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- æ‘˜è¦è®¾ç½® -->
                    <div class="toolbar-setting-item">
                        <button type="button" class="setting-btn" onclick="toggleSummaryPanel()" title="è®¾ç½®æ‘˜è¦" id="summaryBtn">
                            ğŸ“ æ‘˜è¦
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- æ‘˜è¦é¢æ¿ï¼ˆå¯æŠ˜å ï¼‰ -->
            <div class="summary-panel" id="summaryPanel" style="display: none;">
                <div class="summary-panel-content">
                    <label for="summary" class="summary-label">
                        æ–‡ç« æ‘˜è¦ <span style="color: #999;">(é€‰å¡«ï¼Œç”¨äºæç‚¼æ–‡ç« ç²¾åå†…å®¹)</span>
                    </label>
                    <textarea name="summary" id="summary" class="summary-textarea" placeholder="è¯·è¾“å…¥æ–‡ç« æ‘˜è¦ï¼Œç®€è¦æ¦‚æ‹¬æ–‡ç« çš„æ ¸å¿ƒå†…å®¹..." maxlength="200"></textarea>
                    <div class="summary-counter">
                        <span id="summaryCount">0</span>/200å­—
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘å™¨å†…å®¹åŒº -->
        <div class="editor-content">
            <!-- ç¼–è¾‘é¢æ¿ -->
            <div class="editor-pane left">
                <form method="POST" enctype="multipart/form-data" style="height: 100%; display: flex; flex-direction: column;">
                    <!-- æ ‡é¢˜è¾“å…¥åŒºåŸŸ -->
                    <div class="title-input-area" style="padding: 16px 20px; border-bottom: 1px solid #e4e6ea;">
                        <input type="text" name="title" class="title-input" placeholder="è¾“å…¥æ–‡ç« æ ‡é¢˜..." style="border: none; outline: none; font-size: 18px; font-weight: 500; padding: 8px 0; background: transparent; width: 100%;" required>
                    </div>
                    
                    <!-- å†…å®¹ç¼–è¾‘åŒº -->
                    <textarea name="content" class="editor-textarea" id="content" placeholder="è¯·è¾“å…¥æ–‡ç« å†…å®¹ï¼Œæ”¯æŒ Markdown è¯­æ³•..."></textarea>
                    
                    <!-- éšè—çš„è¡¨å•å­—æ®µ -->
                    <input type="hidden" name="category_id" id="hiddenCategoryId">
                    <input type="hidden" name="summary" id="hiddenSummary">
                    <input type="file" name="cover_image" id="hiddenCoverImage" style="display: none;">
                    
                    <!-- éšè—çš„æäº¤æŒ‰é’®ï¼Œé€šè¿‡åº•éƒ¨æŒ‰é’®è§¦å‘ -->
                    <button type="submit" id="hiddenSubmit" style="display: none;"></button>
                </form>
            </div>

            <!-- é¢„è§ˆé¢æ¿ -->
            <div class="editor-pane">
                <div class="preview-pane" id="preview">
                    <div class="preview-empty">
                        <div class="preview-empty-icon">ğŸ“</div>
                        <div class="preview-empty-text">å¼€å§‹å†™ä½œå§</div>
                        <div class="preview-empty-hint">åœ¨å·¦ä¾§ç¼–è¾‘å™¨ä¸­è¾“å…¥å†…å®¹ï¼Œè¿™é‡Œä¼šå®æ—¶æ˜¾ç¤ºé¢„è§ˆæ•ˆæœ</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¼–è¾‘å™¨åº•éƒ¨ -->
        <div class="editor-footer">
            <div class="editor-stats">
                <div class="stat-item">
                    <span>å­—ç¬¦æ•°:</span>
                    <span id="charCount">0</span>
                </div>
                <div class="stat-item">
                    <span>å•è¯æ•°:</span>
                    <span id="wordCount">0</span>
                </div>
                <div class="stat-item">
                    <span>è¡Œæ•°:</span>
                    <span id="lineCount">1</span>
                </div>
            </div>
            <div class="editor-actions">
                <button type="button" class="action-btn" onclick="saveDraft()">å­˜è‰ç¨¿</button>
                <button type="button" class="action-btn" onclick="publishArticle()">å‘å¸ƒæ–‡ç« </button>
            </div>
        </div>
    </div>
</div>

<!-- Marked.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>

<script>
// è·å–DOMå…ƒç´ 
const contentTextarea = document.getElementById('content');
const titleInput = document.querySelector('.title-input');
const summaryTextarea = document.getElementById('summary');
const previewPane = document.getElementById('preview');
const charCountSpan = document.getElementById('charCount');
const wordCountSpan = document.getElementById('wordCount');
const lineCountSpan = document.getElementById('lineCount');
const summaryCountSpan = document.getElementById('summaryCount');

// å®æ—¶é¢„è§ˆåŠŸèƒ½
function updatePreview() {
    const content = contentTextarea.value;
    
    if (content.trim() === '') {
        previewPane.innerHTML = `
            <div class="preview-empty">
                <div class="preview-empty-icon">ğŸ“</div>
                <div class="preview-empty-text">å¼€å§‹å†™ä½œå§</div>
                <div class="preview-empty-hint">åœ¨å·¦ä¾§ç¼–è¾‘å™¨ä¸­è¾“å…¥å†…å®¹ï¼Œè¿™é‡Œä¼šå®æ—¶æ˜¾ç¤ºé¢„è§ˆæ•ˆæœ</div>
            </div>
        `;
    } else {
        try {
            previewPane.innerHTML = marked.parse(content);
        } catch (error) {
            previewPane.innerHTML = '<p style="color: #e74c3c;">é¢„è§ˆè§£æé”™è¯¯</p>';
        }
    }
    
    updateStats();
}

// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
function updateStats() {
    const content = contentTextarea.value;
    const charCount = content.length;
    const wordCount = content.trim() === '' ? 0 : content.trim().split(/\s+/).length;
    const lineCount = content.split('\n').length;
    
    charCountSpan.textContent = charCount;
    wordCountSpan.textContent = wordCount;
    lineCountSpan.textContent = lineCount;
}

// æ›´æ–°æ‘˜è¦å­—ç¬¦è®¡æ•°
function updateSummaryCount() {
    const summary = summaryTextarea.value;
    const count = summary.length;
    summaryCountSpan.textContent = count;
    
    // è¶…è¿‡200å­—æ—¶å˜çº¢æç¤º
    if (count > 200) {
        summaryCountSpan.style.color = '#e74c3c';
    } else {
        summaryCountSpan.style.color = '#999';
    }
}

// æ’å…¥Markdownè¯­æ³•
function insertMarkdown(before, after) {
    const start = contentTextarea.selectionStart;
    const end = contentTextarea.selectionEnd;
    const selectedText = contentTextarea.value.substring(start, end);
    const newText = before + selectedText + after;
    
    contentTextarea.value = contentTextarea.value.substring(0, start) + newText + contentTextarea.value.substring(end);
    
    // è®¾ç½®å…‰æ ‡ä½ç½®
    const newCursorPos = start + before.length + selectedText.length;
    contentTextarea.setSelectionRange(newCursorPos, newCursorPos);
    contentTextarea.focus();
    
    updatePreview();
}

// æ’å…¥è¡¨æ ¼
function insertTable() {
    const tableMarkdown = '\n| åˆ—1 | åˆ—2 | åˆ—3 |\n|-----|-----|-----|\n| å†…å®¹1 | å†…å®¹2 | å†…å®¹3 |\n| å†…å®¹4 | å†…å®¹5 | å†…å®¹6 |\n';
    insertMarkdown(tableMarkdown, '');
}

// æ¸…ç©ºç¼–è¾‘å™¨
function clearEditor() {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿ')) {
        contentTextarea.value = '';
        titleInput.value = '';
        summaryTextarea.value = '';
        updatePreview();
        updateSummaryCount();
    }
}

// è§¦å‘å›¾ç‰‡ä¸Šä¼ 
function triggerImageUpload() {
    document.getElementById('imageUpload').click();
}

// å¤„ç†å›¾ç‰‡ä¸Šä¼ 
function handleImageUpload(input) {
    const file = input.files[0];
    if (!file) return;
    
    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
    if (!file.type.startsWith('image/')) {
        alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
        return;
    }
    
    // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º5MBï¼‰
    if (file.size > 5 * 1024 * 1024) {
        alert('å›¾ç‰‡æ–‡ä»¶ä¸èƒ½è¶…è¿‡5MB');
        return;
    }
    
    uploadImage(file);
}

// ä¸Šä¼ å›¾ç‰‡åˆ°æœåŠ¡å™¨
function uploadImage(file) {
    const formData = new FormData();
    formData.append('image', file);
    
    // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
    const uploadingText = '![ä¸Šä¼ ä¸­...](uploading)';
    insertMarkdown(uploadingText, '');
    
    fetch('/upload_image', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // æ›¿æ¢ä¸Šä¼ ä¸­çš„æ–‡æœ¬ä¸ºå®é™…çš„å›¾ç‰‡é“¾æ¥
            const imageMarkdown = `![${file.name}](${data.url})`;
            const content = contentTextarea.value;
            const newContent = content.replace(uploadingText, imageMarkdown);
            contentTextarea.value = newContent;
            updatePreview();
        } else {
            // ç§»é™¤ä¸Šä¼ ä¸­çš„æ–‡æœ¬
            const content = contentTextarea.value;
            const newContent = content.replace(uploadingText, '');
            contentTextarea.value = newContent;
            updatePreview();
            alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        // ç§»é™¤ä¸Šä¼ ä¸­çš„æ–‡æœ¬
        const content = contentTextarea.value;
        const newContent = content.replace(uploadingText, '');
        contentTextarea.value = newContent;
        updatePreview();
        alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + error.message);
    });
}

// å¤„ç†å¤åˆ¶ç²˜è´´å›¾ç‰‡
function handlePaste(e) {
    const items = e.clipboardData.items;
    
    for (let i = 0; i < items.length; i++) {
        const item = items[i];
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºå›¾ç‰‡
        if (item.type.indexOf('image') !== -1) {
            e.preventDefault();
            const file = item.getAsFile();
            uploadImage(file);
            break;
        }
    }
}

// å¤„ç†æ‹–æ‹½ä¸Šä¼ 
function handleDragOver(e) {
    e.preventDefault();
    e.stopPropagation();
    contentTextarea.style.backgroundColor = '#f0f8ff';
}

function handleDragLeave(e) {
    e.preventDefault();
    e.stopPropagation();
    contentTextarea.style.backgroundColor = '';
}

function handleDrop(e) {
    e.preventDefault();
    e.stopPropagation();
    contentTextarea.style.backgroundColor = '';
    
    const files = e.dataTransfer.files;
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (file.type.startsWith('image/')) {
            uploadImage(file);
        }
    }
}

// é¦–å›¾ä¸Šä¼ åŠŸèƒ½
function triggerCoverImageUpload() {
    document.getElementById('coverImageInput').click();
}

function handleCoverImageUpload(input) {
    const file = input.files[0];
    if (!file) return;
    
    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
    if (!file.type.startsWith('image/')) {
        alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
        return;
    }
    
    // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º5MBï¼‰
    if (file.size > 5 * 1024 * 1024) {
        alert('å›¾ç‰‡æ–‡ä»¶ä¸èƒ½è¶…è¿‡5MB');
        return;
    }
    
    // é¢„è§ˆå›¾ç‰‡
    const reader = new FileReader();
    reader.onload = function(e) {
        const preview = document.getElementById('coverImagePreview');
        const img = document.getElementById('coverImageImg');
        const uploadBtn = document.querySelector('.cover-image-btn');
        
        img.src = e.target.result;
        preview.style.display = 'block';
        uploadBtn.style.display = 'none';
    };
    reader.readAsDataURL(file);
}

function removeCoverImage() {
    const preview = document.getElementById('coverImagePreview');
    const uploadBtn = document.querySelector('.cover-image-btn');
    const input = document.getElementById('coverImageInput');
    
    preview.style.display = 'none';
    uploadBtn.style.display = 'flex';
    input.value = '';
}

// å…¨å±åˆ‡æ¢
function toggleFullscreen() {
    const editor = document.querySelector('.juejin-editor');
    editor.classList.toggle('fullscreen');
    
    // æ›´æ–°æŒ‰é’®æ–‡æœ¬
    const btn = event.target;
    btn.textContent = editor.classList.contains('fullscreen') ? 'é€€å‡ºå…¨å±' : 'â›¶';
}

// ä¸“æ³¨æ¨¡å¼åˆ‡æ¢
function toggleFocusMode() {
    const editor = document.querySelector('.juejin-editor');
    const focusBtn = document.getElementById('focusModeBtn');
    
    editor.classList.toggle('focus-mode');
    
    if (editor.classList.contains('focus-mode')) {
        focusBtn.textContent = 'é€€å‡ºä¸“æ³¨';
        focusBtn.title = 'é€€å‡ºä¸“æ³¨æ¨¡å¼';
        // éšè—é¢„è§ˆé¢æ¿ï¼Œåªæ˜¾ç¤ºç¼–è¾‘å™¨
        document.querySelector('.editor-pane:not(.left)').style.display = 'none';
        document.querySelector('.editor-pane.left').style.width = '100%';
        // èšç„¦åˆ°å†…å®¹ç¼–è¾‘åŒº
        contentTextarea.focus();
    } else {
        focusBtn.textContent = 'ğŸ¯';
        focusBtn.title = 'ä¸“æ³¨æ¨¡å¼';
        // æ¢å¤é¢„è§ˆé¢æ¿
        document.querySelector('.editor-pane:not(.left)').style.display = 'block';
        document.querySelector('.editor-pane.left').style.width = '50%';
    }
}

// å­˜è‰ç¨¿
function saveDraft() {
    const title = titleInput.value.trim();
    const content = contentTextarea.value.trim();
    
    if (!title && !content) {
        alert('è¯·è¾“å…¥æ ‡é¢˜æˆ–å†…å®¹');
        return;
    }
    
    // è¿™é‡Œå¯ä»¥å®ç°è‰ç¨¿ä¿å­˜åŠŸèƒ½
    alert('è‰ç¨¿å·²ä¿å­˜ï¼ˆåŠŸèƒ½å¾…å®ç°ï¼‰');
}

// æ‘˜è¦é¢æ¿åˆ‡æ¢
function toggleSummaryPanel() {
    const panel = document.getElementById('summaryPanel');
    const btn = document.getElementById('summaryBtn');
    
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        btn.style.background = '#e3f2fd';
        btn.style.color = '#1976d2';
    } else {
        panel.style.display = 'none';
        btn.style.background = '';
        btn.style.color = '';
    }
}

// é¦–å›¾ä¸Šä¼ åŠŸèƒ½ï¼ˆæ›´æ–°ç‰ˆï¼‰
function triggerCoverImageUpload() {
    document.getElementById('coverImageInput').click();
}

function handleCoverImageUpload(input) {
    const file = input.files[0];
    if (!file) return;
    
    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
    if (!file.type.startsWith('image/')) {
        alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
        return;
    }
    
    // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º5MBï¼‰
    if (file.size > 5 * 1024 * 1024) {
        alert('å›¾ç‰‡æ–‡ä»¶ä¸èƒ½è¶…è¿‡5MB');
        return;
    }
    
    // é¢„è§ˆå›¾ç‰‡
    const reader = new FileReader();
    reader.onload = function(e) {
        const miniPreview = document.getElementById('coverPreviewMini');
        const miniImg = document.getElementById('coverImageMini');
        const uploadBtn = document.querySelector('.setting-btn[title="è®¾ç½®é¦–å›¾"]');
        
        miniImg.src = e.target.result;
        miniPreview.style.display = 'block';
        uploadBtn.style.display = 'none';
    };
    reader.readAsDataURL(file);
}

function removeCoverImage() {
    const miniPreview = document.getElementById('coverPreviewMini');
    const uploadBtn = document.querySelector('.setting-btn[title="è®¾ç½®é¦–å›¾"]');
    const input = document.getElementById('coverImageInput');
    
    miniPreview.style.display = 'none';
    uploadBtn.style.display = 'inline-flex';
    input.value = '';
}

// å‘å¸ƒæ–‡ç« 
function publishArticle() {
    const title = titleInput.value.trim();
    const content = contentTextarea.value.trim();
    const summary = summaryTextarea.value.trim();
    const categorySelect = document.getElementById('category_id');
    const categoryId = categorySelect.value;
    
    if (!title) {
        alert('è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜');
        titleInput.focus();
        return;
    }
    
    if (!content) {
        alert('è¯·è¾“å…¥æ–‡ç« å†…å®¹');
        contentTextarea.focus();
        return;
    }
    
    if (!categoryId) {
        alert('è¯·é€‰æ‹©ä¸“æ ');
        categorySelect.focus();
        return;
    }
    
    // æ£€æŸ¥æ‘˜è¦é•¿åº¦
    if (summary.length > 200) {
        alert('æ–‡ç« æ‘˜è¦ä¸èƒ½è¶…è¿‡200å­—');
        summaryTextarea.focus();
        return;
    }
    
    // åŒæ­¥è¡¨å•å­—æ®µå€¼
    document.getElementById('hiddenCategoryId').value = categoryId;
    document.getElementById('hiddenSummary').value = summary;
    
    // åŒæ­¥é¦–å›¾æ–‡ä»¶ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
    const coverImageInput = document.getElementById('coverImageInput');
    const hiddenCoverImageInput = document.getElementById('hiddenCoverImage');
    if (coverImageInput && coverImageInput.files.length > 0) {
        // åˆ›å»ºæ–°çš„æ–‡ä»¶è¾“å…¥æ¥ä¼ é€’æ–‡ä»¶
        const dt = new DataTransfer();
        dt.items.add(coverImageInput.files[0]);
        hiddenCoverImageInput.files = dt.files;
    }
    
    // æäº¤è¡¨å•
    document.getElementById('hiddenSubmit').click();
}

// å¿«æ·é”®æ”¯æŒ
document.addEventListener('keydown', function(e) {
    const isCtrlOrCmd = e.ctrlKey || e.metaKey;
    
    if (isCtrlOrCmd) {
        switch(e.key.toLowerCase()) {
            case 'b':
                e.preventDefault();
                insertMarkdown('**', '**');
                break;
            case 'i':
                e.preventDefault();
                insertMarkdown('*', '*');
                break;
            case 'k':
                e.preventDefault();
                insertMarkdown('[', '](url)');
                break;
            case '1':
                e.preventDefault();
                insertMarkdown('# ', '');
                break;
            case 'enter':
                e.preventDefault();
                publishArticle();
                break;
        }
    }
    
    if (isCtrlOrCmd && e.shiftKey) {
        switch(e.key.toLowerCase()) {
            case 'c':
                e.preventDefault();
                insertMarkdown('\n```\n', '\n```\n');
                break;
            case 'k':
                e.preventDefault();
                insertMarkdown('`', '`');
                break;
            case 'i':
                e.preventDefault();
                insertMarkdown('![', '](image-url)');
                break;
            case 'l':
                e.preventDefault();
                insertMarkdown('\n- ', '');
                break;
        }
    }
    
    // Tabé”®å¤„ç†
    if (e.key === 'Tab' && e.target === contentTextarea) {
        e.preventDefault();
        const start = contentTextarea.selectionStart;
        const end = contentTextarea.selectionEnd;
        contentTextarea.value = contentTextarea.value.substring(0, start) + '  ' + contentTextarea.value.substring(end);
        contentTextarea.selectionStart = contentTextarea.selectionEnd = start + 2;
        updatePreview();
    }
});

// ç›‘å¬è¾“å…¥äº‹ä»¶
contentTextarea.addEventListener('input', updatePreview);
titleInput.addEventListener('input', updateStats);
summaryTextarea.addEventListener('input', updateSummaryCount);

// æ·»åŠ å¤åˆ¶ç²˜è´´å’Œæ‹–æ‹½äº‹ä»¶ç›‘å¬å™¨
contentTextarea.addEventListener('paste', handlePaste);
contentTextarea.addEventListener('dragover', handleDragOver);
contentTextarea.addEventListener('dragleave', handleDragLeave);
contentTextarea.addEventListener('drop', handleDrop);

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    updatePreview();
    updateSummaryCount();
    
    // æ£€æŸ¥marked.jsæ˜¯å¦åŠ è½½æˆåŠŸ
    if (typeof marked === 'undefined') {
        console.error('Marked.js åŠ è½½å¤±è´¥ï¼Œé¢„è§ˆåŠŸèƒ½å¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œ');
        previewPane.innerHTML = '<p style="color: #e74c3c;">é¢„è§ˆåŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>';
    }
});

// ESCé”®é€€å‡ºå…¨å±
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const editor = document.querySelector('.juejin-editor');
        if (editor.classList.contains('fullscreen')) {
            editor.classList.remove('fullscreen');
            const fullscreenBtn = document.querySelector('.juejin-toolbar-btn[title="å…¨å±"]');
            if (fullscreenBtn) fullscreenBtn.textContent = 'â›¶';
        }
    }
});
</script>

<style>
/* å·¥å…·æ å¸ƒå±€æ ·å¼ */
.juejin-editor-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
}

.toolbar-left {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 4px;
}

.toolbar-right {
    display: flex;
    align-items: center;
    gap: 12px;
}

.toolbar-setting-item {
    position: relative;
    display: flex;
    align-items: center;
}

/* è®¾ç½®æŒ‰é’®æ ·å¼ */
.setting-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    background: #ffffff;
    color: #374151;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
}

.setting-btn:hover {
    background: #f3f4f6;
    border-color: #9ca3af;
}

.setting-btn:active {
    background: #e5e7eb;
}

/* ä¸“æ é€‰æ‹©æ ·å¼ */
.setting-select {
    padding: 6px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    background: #ffffff;
    color: #374151;
    font-size: 13px;
    cursor: pointer;
    min-width: 120px;
    transition: all 0.2s;
}

.setting-select:hover {
    border-color: #9ca3af;
}

.setting-select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* é¦–å›¾é¢„è§ˆæ ·å¼ */
.cover-preview-mini {
    position: relative;
    display: inline-block;
    margin-left: 8px;
}

/* æ‘˜è¦é¢æ¿æ ·å¼ */
.summary-panel {
    background: #f8f9fa;
    border-top: 1px solid #e4e6ea;
    padding: 16px 20px;
    animation: slideDown 0.3s ease;
}

.summary-panel-content {
    max-width: 600px;
}

.summary-label {
    display: block;
    font-size: 14px;
    color: #666;
    margin-bottom: 8px;
    font-weight: 500;
}

.summary-textarea {
    width: 100%;
    min-height: 80px;
    padding: 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    background: #ffffff;
    font-size: 14px;
    line-height: 1.5;
    resize: vertical;
    transition: border-color 0.2s;
}

.summary-textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.summary-counter {
    text-align: right;
    font-size: 12px;
    color: #6b7280;
    margin-top: 8px;
    transition: color 0.3s ease;
}

/* åŠ¨ç”»æ•ˆæœ */
@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* æ ‡é¢˜è¾“å…¥æ¡†æ ·å¼ */
.form-control {
    border: none !important;
    box-shadow: none !important;
}

.form-control:focus {
    border: none !important;
    box-shadow: none !important;
    outline: none !important;
}

/* å…¨å±æ¨¡å¼ä¸‹çš„æ ·å¼è°ƒæ•´ */
.juejin-editor.fullscreen {
    background: #ffffff;
}

.juejin-editor.fullscreen .editor-content {
    min-height: calc(100vh - 140px);
}

/* ä¸“æ³¨æ¨¡å¼æ ·å¼ */
.juejin-editor.focus-mode {
    background: #f8f9fa;
}

.juejin-editor.focus-mode .editor-header {
    background: #ffffff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.juejin-editor.focus-mode .editor-footer {
    background: #ffffff;
    box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
}

.juejin-editor.focus-mode .editor-pane.left {
    transition: width 0.3s ease;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
    .container-fluid {
        padding: 0 !important;
    }
    
    .juejin-editor {
        margin: 0;
        border-radius: 0;
    }
    
    .juejin-editor.focus-mode .editor-pane.left {
        width: 100% !important;
    }
    
    .juejin-editor-toolbar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .toolbar-left,
    .toolbar-right {
        justify-content: center;
    }
    
    .toolbar-right {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid #e4e6ea;
    }
    
    .setting-btn,
    .setting-select {
        font-size: 12px;
        padding: 4px 8px;
    }
}
</style>
{% endblock %}